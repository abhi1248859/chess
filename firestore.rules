
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Rule for user-specific data (if any in the future)
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Rules for multiplayer games
    match /games/{gameId} {
      // Allow any logged-in user to read any game. This is required
      // for players to join and watch games.
      allow read: if request.auth != null;

      // Allow a logged-in user to create a game, but only if they
      // set themselves as player1.
      allow create: if request.auth != null &&
                       request.resource.data.player1.uid == request.auth.uid;

      // Allow updates only for joining or for players making a move on their turn.
      allow update: if request.auth != null &&
                       (
                         // Scenario 1: Player 2 joins the game.
                         (resource.data.player2 == null &&
                          request.resource.data.player2.uid == request.auth.uid &&
                          resource.data.player1.uid != request.auth.uid)
                         ||
                         // Scenario 2: Player 1 (white) makes a move on their turn.
                         (resource.data.turn == 'w' &&
                          resource.data.player1.uid == request.auth.uid)
                         ||
                         // Scenario 3: Player 2 (black) makes a move on their turn.
                         (resource.data.turn == 'b' &&
                          resource.data.player2.uid == request.auth.uid)
                       );
    }
  }
}
